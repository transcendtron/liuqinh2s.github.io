---
layout: post
title: C语言回炉重造笔记
categories: 魔法手册
tags: [C语言, 教程, 编程语言]
comments: true
---

# C缺陷与陷阱

## 词法“陷阱”

### `=` 不同于 `==`

为什么赋值使用`=`，比较使用`==`呢？

由Algol派生而来的大多数程序设计语言，例如 Pascal 和 Ada，使用符号 `:=` 作为赋值运算符，符号 `=` 作为比较运算符。而C语言使用另一种表示法，符号 `=` 作为赋值运算符，符号 `==` 作为比较运算符。**一般而言赋值运算相对于比较运算出现得更频繁，因为字符较少的 `=` 就被赋予了更常用的含义--赋值操作。** 此外，**在C语言中赋值符号被作为一种操作符对待**，因而重复进行赋值操作（a=b=c）可以很容易地书写，并且赋值操作还可以被嵌入到更大的表达式当中去。

由此产生一个问题，**很多新手容易将比较运算符 `==` 错写成赋值运算符 `=`**。

看例子：

```c
while(c = ' ' || c == '\t' || c == '\n')
  c = getc(f);
```

由于程序员在比较 `' '` 和 c 时，误将比较运算符 `==` 写成了 赋值运算符 `=` 。 因为赋值运算符 `=` 的优先级要低于逻辑运算符 `||` ，因此实际上是以下表达式 `' ' || c == '\t' || c == '\n'` 赋给了 c 。因为 `' '`不等于0（`' '`的ASCII码值为32），**那么无论变量c此前为何值，上述表达式求值的结果都是1**，因此循环将一直进行下去直到整个文件结束。文件结束之后循环是否还会进行下去，这取决于 `getc` 库函数的具体实现，在文件指针达到文件结尾之后是否还允许继续读取字符。如果允许继续读取字符，那么循环将一直进行下去，从而成为一个死循环。

### 词法分析中的贪心法

一些 C 记号，如 `/、*和=` 只有一个字符。而其他一些 C 记号，如 `/*和==` ，以及标识符，具有多个字符。当 C 编译器遇到紧连在一起的/和*时，它必须能够决定是将这两个字符识别为两个分离的记号还是一个单独的记号。C语言对这个问题的解决方案可以归结为一个很简单的规则：每个符号应该包含尽可能多的字符。这个策略被称为 **贪心法**。

看例子：

表达式

```c
a --- b
```

与表达式

```c
a -- - b
```

的含义相同，而与

```c
a - -- b
```

的含义不同。

### 整形常量与进制

如果整形常量的第一个字符是数字0，那么该常量将被视作八进制数，因此，10与010的含义截然不同。0x代表16进制。

### 字符与字符串

C语言单引号和双引号含义迥异，在某些情况下把两者弄混，编译器并不会检测报错，从而在运行时产生难以预料的效果。

用单引号引起的一个字符实际上代表一个整数，整数值对应于该字符在编译器采用的字符集中的序列值，因此，对于采用ASCII字符集的编译器而言，`'a'`的含义与`0141`(八进制)或者`97`(十进制)严格一致。

用双引号引起的字符串，代表的确是一个指向无名数组起始字符的指针，该数组被引号之间的字符以及一个额外的二进制为零的字符'\0'初始化。

下面的这个语句：

```c
printf("Hello world\n");
//与
char s[] = {'H','e','l','l','o',' ','w','o','r','l','d','\n',0};
printf("%s\n", s);
```

![C语言字符和字符串](https://wx4.sinaimg.cn/mw690/006zFO3ggy1fd4ss43xi0j31080j8n3x.jpg)

## 语法“陷阱”

### 理解函数声明

任何C语言变量的声明都由两部分组成：类型以及一组类似表达式的声明符（declarator）。

```
float f,g;
float ((f));
float ff();
float *pf;
float *g(),(*h)();
(float (*)())
```

搞懂上面的，然后来个组合重磅的：

```
(* (void (*)())0)();
```

`(void (*)())0`的意思是对0进行强制类型转换，类型是：`void (*)()`，而这是一个函数指针，该函数返回值是void。

外面还有一个函数指针，实际上还省略了void，上式实际上是`void (* (void (*)())0)();`。用typedef可以实现相同的效果：

```
typedef void (*funcptr)();
(* (funcptr)0)();
```
